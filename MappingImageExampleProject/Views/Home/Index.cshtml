<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">

<style>
    area:link, area:hover, area:active, area:focus {
        border: 10px #f00 solid;
        border-radius: 0px;
        width: 80%;
    }
</style>


<div class="row my-5"></div>

<div class="row">

    <div class=" col-md-2 text-center" style="padding: 0px;">
        <div class="dropdown">
            <button id="item" type="button" class="btn btn-info mb-1 dropdown-toggle" style="border:none; border-radius: 0px; width: 80%;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><strong><i class="float-left">+ &nbsp;</i>Add Item</strong></button>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <button id="btnAddRectangleTag" type="button" class="dropdown-item btn btn-success mb-1" style="border:none; border-radius: 0px; width: 80%;"><strong><i class="float-left">+ &nbsp;</i>Rectangle</strong></button>
                <button id="btnAddPolygonTag" type="button" class="dropdown-item btn btn-success mb-1" style="border: none; border-radius: 0px; width: 80%;"><strong><i class="float-left">+ &nbsp;</i>Polygon</strong></button>
            </div>
        </div>

        <div class="dropdown">
            <button id="link" type="button" class="btn btn-info mb-1 dropdown-toggle" style="border:none; border-radius: 0px; width: 80%;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><strong><i class="float-left">+ &nbsp;</i>Add Link</strong></button>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <button id="btnAddRectangleLink" type="button" class="dropdown-item btn btn-success mb-1" style="border:none; border-radius: 0px; width: 80%;"><strong><i class="float-left">+ &nbsp;</i>Rectangle</strong></button>
                <button id="btnAddPolygonLink" type="button" class="dropdown-item btn btn-success mb-1" style="border: none; border-radius: 0px; width: 80%;"><strong><i class="float-left">+ &nbsp;</i>Polygon</strong></button>
            </div>
        </div>

        <div id="currentTags">
            @*<map name="arlentusMap">
                    <area title="hi!" shape="rect" coords="0,0,300,300" href="#">
                </map>*@
        </div>
    </div>

    <div class="col-md-8" style="padding: 0px;">
        <canvas id="image" width="1080" height="720" style="border: 2px solid black; border-style: dashed;" hidden></canvas>
        <img class="map" id="arlentusImage" src="~/img/1080x720.jpg" style="width: 1080px; height: 720px;" usemap="#arlentusMap">
    </div>

    <div class="col-md-2" style="padding: 0px;">

    </div>

    @* TAG MODAL *@
    <div class="modal fade" id="AddSpecificationModal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">
                    <h2 class="modal-title">Item [RES1012]</h2>

                    <div class="col-sm-8">
                        <ul class="nav nav-pills mt-2">
                            <li class="nav-item"><a class="nav-link active" style="border:none;border-radius:0px" href="#information" data-toggle="tab">Item Information</a></li>

                            <li class="nav-item"><a class="nav-link" style="border:none;border-radius:0px" href="#attachments" data-toggle="tab">Attachments</a></li>

                            <li class="nav-item"><a class="nav-link" style="border:none;border-radius:0px" href="#inspections" data-toggle="tab">Inspections</a></li>
                        </ul>
                    </div>

                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">

                    <div class="tab-content">
                        <div class="active tab-pane" id="information">
                            @await Html.PartialAsync("ItemInformationPartial")
                        </div>
                        <div class="tab-pane" id="attachments">
                            @await Html.PartialAsync("AttachmentsPartial")
                        </div>
                        <div class="tab-pane" id="inspections">
                            @await Html.PartialAsync("InspectionsPartial")
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    @* LINK MODAL *@
    <div class="modal " id="AddSpecificationModal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">
                    <h2 class="modal-title">Item [LINK1019]</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">

                  

                </div>

            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.ui.position.js"></script>
    <script src="~/js/maphilight.js"></script>
    @*<script sr c="~/js/wheelzoom.js"></script>*@
    @*wheelzoom(document.querySelectorAll('img'));*@

    <script>
        $(function () {

            ///////////////////////////////////////////////////////////////////////////////////////////// [GENERAL VARIABLES]
            var canvas = document.getElementById("image")
            var context = canvas.getContext("2d");
            var img = document.getElementById("arlentusImage");
            var currentMapCount = 0;
            var imgMap;
            context.drawImage(img, 0, 0);

            ///////////////////////////////////////////////////////////////////////////////////////////// [ADD TAG]
            $("#AddSpecificationModal").on('show.bs.modal', function () {
                document.getElementById('frmAddSpecification').reset();
            });



            /////////////////////////////////////////////////////////////// [RIGHT CLICK MENU]
            $.contextMenu({
                selector: '.right-click-menu',
                items: {
                    // <input type="text">
                    name: {
                        name: "Title",
                        type: 'text',
                        events: {
                            keyup: function (e) {
                                // add some fancy key handling here?
                                window.console && console.log('key: ' + e.keyCode);
                            }
                        }
                    },
                    sep1: "---------",
                    // <input type="checkbox">
                    yesno: {
                        name: "Process Completed!",
                        type: 'checkbox',
                        selected: true
                    },
                    sep2: "---------",
                    // <input type="radio">
                    radio1: {
                        name: "True",
                        type: 'radio',
                        radio: 'radio',
                        value: '1'
                    },
                    radio2: {
                        name: "False",
                        type: 'radio',
                        radio: 'radio',
                        value: '2',
                        selected: true
                    },
                    sep3: "---------",
                    // <select>
                    select: {
                        name: "Select",
                        type: 'select',
                        options: { 1: 'one', 2: 'two', 3: 'three' },
                        selected: 2
                    },
                    // <textarea>
                    area1: {
                        name: "Defination",
                        type: 'textarea',
                        value: "Hello World",
                        height: 20
                    },
                    area2: {
                        name: "Description",
                        type: 'textarea',
                        value: "Hello World",
                        height: 40
                    },
                    sep4: "---------",
                    key: {
                        name: "Save",
                        callback: $.noop
                    }
                },
                events: {
                    show: function (opt) {
                        // this is the trigger element
                        var $this = this;
                        // import states from data store
                        $.contextMenu.setInputValues(opt, $this.data());
                        // this basically fills the input commands from an object
                        // like {name: "foo", yesno: true, radio: "3", &hellip;}
                    },
                    hide: function (opt) {
                        // this is the trigger element
                        var $this = this;
                        // export states to data store
                        $.contextMenu.getInputValues(opt, $this.data());
                        // this basically dumps the input commands' values to an object
                        // like {name: "foo", yesno: true, radio: "3", &hellip;}
                    }
                }
            });

            /////////////////////////////////////////////////////////////// [ADD POLYGON TAG BUTTON]
            var currentPolyCoords = [];
            var currentPolyCount = 0;
            var isPolyActive = false;
            var polyPoints = [];

            $("#btnAddPolygonTag").click(function () {
                polyPoints.length = 0;
                isPolyActive = true;
                img.setAttribute("hidden", "");
                canvas.removeAttribute("hidden");

                canvas.onmousedown = function (e) {
                    polyPoints.push({
                        x: e.offsetX,
                        y: e.offsetY
                    });
                    redraw();
                }

                // When Pressed "ESC"
                document.addEventListener('keydown', e => {
                    if (e.key == 'Escape' && isPolyActive == true) {
                        if (polyPoints.length > 2) {
                            isPolyActive = false;
                            var polyCoords = polyPoints[0].x + "," + polyPoints[0].y + " ";
                            for (var i = 1; i < polyPoints.length; i++) {
                                polyCoords += polyPoints[i].x + "," + polyPoints[i].y + " ";
                            }
                            currentPolyCoords[currentPolyCount] = polyCoords;
                            polyCoords = 0;
                            if (currentMapCount == 0) {
                                imgMapButton = $('<button>', {
                                    'id': 'poly' + (currentPolyCount + 1) + 'Button',
                                    'type': 'button',
                                    'class': 'btn btn-danger mb-1',
                                    'style': 'border:none; border-radius: 0px; width: 80%;',
                                    'data-toggle': 'modal',
                                    'data-target': '#AddSpecificationModal',
                                    'data-backdrop': 'static',
                                    'data-keyboard': 'false'
                                });
                                imgMapButton.text('Polygon Tag' + " " + (currentPolyCount + 1));

                                imgMap = $('<map>', {
                                    'name': 'arlentusMap',
                                    'class': 'right-click-menu'
                                }).append($('<area>', {
                                    'id': 'poly' + (currentPolyCount + 1),
                                    'shape': 'poly',
                                    'title': 'polyTag' + (currentPolyCount + 1),
                                    'coords': currentPolyCoords[currentPolyCount],
                                    'href': '',
                                    'data-toggle': 'modal',
                                    'data-target': '#AddSpecificationModal',
                                    'data-backdrop': 'static',
                                    'data-keyboard': 'false'
                                }));
                                $("#currentTags").append($('<br>'));
                                $("#currentTags").append(imgMap);
                                $("#currentTags").append($('<br>'));
                                $("#currentTags").append($('<br>'));
                                $("#currentTags").append(imgMapButton);
                                $("#currentTags").append($('<br>'));
                                currentMapCount++;
                            }
                            else {
                                var imgMapButton = $('<button>', {
                                    'id': 'poly' + (currentPolyCount + 1) + 'Button',
                                    'type': 'button',
                                    'class': 'btn btn-danger mb-1',
                                    'style': 'border:none; border-radius: 0px; width: 80%;',
                                    'data-toggle': 'modal',
                                    'data-target': '#AddSpecificationModal',
                                    'data-backdrop': 'static',
                                    'data-keyboard': 'false'
                                });
                                imgMapButton.text('Polygon Tag' + " " + (currentPolyCount + 1));

                                var imgMapArea = $('<area>', {
                                    'id': 'poly' + (currentPolyCount + 1),
                                    'shape': 'poly',
                                    'title': 'polyTag' + (currentPolyCount + 1),
                                    'coords': currentPolyCoords[currentPolyCount],
                                    'href': '',
                                    'data-toggle': 'modal',
                                    'data-target': '#AddSpecificationModal',
                                    'data-backdrop': 'static',
                                    'data-keyboard': 'false'
                                });
                                $("#currentTags").append(imgMapButton);
                                imgMap.append(imgMapArea);
                                $("#currentTags").append($('<br>'));
                                currentMapCount++;
                            }
                            $('.map').maphilight();
                            currentPolyCount++;
                            canvas.setAttribute("hidden", "");
                            img.removeAttribute("hidden");
                        }
                        else {
                            $('.map').maphilight();
                            canvas.setAttribute("hidden", "");
                            img.removeAttribute("hidden");
                        }
                    }
                });

                // polygon funtions
                function redraw() {
                    canvas.width = canvas.width // clears the canvas
                    context.drawImage(img, 0, 0);

                    drawPolygon();
                    drawPoints();
                }

                function drawPolygon() {
                    context.fillStyle = 'rgba(100, 100, 100, 0.5)';
                    context.strokeStyle = "#df4b26";
                    context.lineWidth = 1;

                    context.beginPath();
                    context.moveTo(polyPoints[0].x, polyPoints[0].y);

                    for (var i = 1; i < polyPoints.length; i++) {
                        context.lineTo(polyPoints[i].x, polyPoints[i].y);
                    }

                    context.closePath();
                    context.fill();
                    context.stroke();
                }

                function drawPoints() {
                    context.strokeStyle = "#000";
                    context.lineJoin = "round";
                    context.lineWidth = 1;

                    for (var i = 0; i < polyPoints.length; i++) {
                        context.beginPath();
                        context.arc(polyPoints[i].x, polyPoints[i].y, 3, 0, 2 * Math.PI, false);
                        context.fillStyle = '#ffffff';
                        context.fill();
                        context.lineWidth = 2;
                        context.stroke();
                    }
                }
            });

            /////////////////////////////////////////////////////////////// [ADD RECTANGLE TAG BUTTON]
            var currentRectCount = 0;
            var isRectExist = false;
            var mousedown = false;
            var rectCoords = [];
            var x1;
            var y1;
            var x2;
            var y2;

            $("#btnAddRectangleTag").click(function () {
                img.setAttribute("hidden", "");
                canvas.removeAttribute("hidden");
                isRectExist = false

                // mouse events
                canvas.onmousedown = function (e) {
                    if (!isRectExist) {
                        mousedown = true;
                        x1 = e.offsetX;
                        y1 = e.offsetY;
                    }
                }

                canvas.onmousemove = function (e) {
                    if (mousedown) {
                        x2 = e.offsetX;
                        y2 = e.offsetY;
                        drawRect()
                    }
                }

                canvas.onmouseup = function (e) {
                    if (mousedown) {
                        isRectExist = true;
                        var rectModel = x1 + "," + y1 + "," + x2 + "," + y2;
                        rectCoords[currentRectCount] = rectModel;
                        if (currentMapCount == 0) {
                            imgMapButton = $('<button>', {
                                'id': 'rect' + (currentRectCount + 1) + 'Button',
                                'type': 'button',
                                'class': 'btn btn-danger mb-1',
                                'style': 'border:none; border-radius: 0px; width: 80%;',
                                'data-toggle': 'modal',
                                'data-target': '#AddSpecificationModal',
                                'data-backdrop': 'static',
                                'data-keyboard': 'false'
                            });
                            imgMapButton.text('Rectangle Tag' + " " + (currentRectCount + 1));

                            imgMap = $('<map>', {
                                'name': 'arlentusMap',
                                'class': 'right-click-menu'
                            }).append($('<area>', {
                                'id': 'rect' + (currentRectCount + 1),
                                'shape': 'rect',
                                'title': 'rectTag' + (currentRectCount + 1),
                                'coords': rectCoords[currentRectCount],
                                'href': '',
                                'data-toggle': 'modal',
                                'data-target': '#AddSpecificationModal',
                                'data-backdrop': 'static',
                                'data-keyboard': 'false'
                            }));
                            $("#currentTags").append($('<br>'));
                            $("#currentTags").append(imgMap);
                            $("#currentTags").append($('<br>'));
                            $("#currentTags").append($('<br>'));
                            $("#currentTags").append(imgMapButton);
                            currentMapCount++;
                        }
                        else {
                            imgMapButton = $('<button>', {
                                'id': 'rect' + (currentPolyCount + 1) + 'Button',
                                'type': 'button',
                                'class': 'btn btn-danger mb-1',
                                'style': 'border:none; border-radius: 0px; width: 80%;',
                                'data-toggle': 'modal',
                                'data-target': '#AddSpecificationModal',
                                'data-backdrop': 'static',
                                'data-keyboard': 'false'
                            });
                            imgMapButton.text('Rectangle Tag' + " " + (currentRectCount + 1));

                            var imgMapArea = $('<area>', {
                                'id': 'rect' + (currentRectCount + 1),
                                'shape': 'rect',
                                'title': 'rectTag' + (currentRectCount + 1),
                                'coords': rectCoords[currentRectCount],
                                'href': '',
                                'data-toggle': 'modal',
                                'data-target': '#AddSpecificationModal',
                                'data-backdrop': 'static',
                                'data-keyboard': 'false'
                            });
                            $("#currentTags").append(imgMapButton);
                            imgMap.append(imgMapArea);
                            $("#currentTags").append($('<br>'));
                            currentMapCount++;
                        }
                        $('.map').maphilight();
                        mousedown = false;
                        currentRectCount++;
                        canvas.setAttribute("hidden", "");
                        img.removeAttribute("hidden");
                    }
                }

                // functions
                function drawRect() {
                    context.lineWidth = 1;
                    context.clearRect(0, 0, 1080, 720);
                    context.drawImage(img, 0, 0);
                    context.beginPath();
                    context.rect(x1, y1, (x2 - x1), (y2 - y1));
                    context.stroke();
                }
            });

            ///////////////////////////////////////////////////////////////////////////////////////////// [ADD LINK]

            /////////////////////////////////////////////////////////////// [ADD RECTANGLE TAG BUTTON]
            $("#btnAddPolygonLink").click(function () {

            });

            /////////////////////////////////////////////////////////////// [ADD RECTANGLE TAG BUTTON]
            $("#btnAddRectangleLink").click(function () {

            });

        });
    </script>
}